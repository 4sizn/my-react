<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suspense Test</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .fallback {
            color: blue;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, Suspense, Component } = React;
        
        // wrappedPromise 함수
        function wrappedPromise(promise) {
            let status = "pending";
            let result = undefined;

            const suspender = promise
                .then((data) => {
                    status = "success";
                    result = data;
                })
                .catch((error) => {
                    status = "error";
                    result = error;
                });

            return {
                suspenseRead() {
                    if (status === "pending") {
                        throw suspender;
                    } else if (status === "error") {
                        throw result;
                    } else if (status === "success") {
                        return result;
                    }
                },
            };
        }

        // withProcedure HOC
        function withProcedure(WrappedComponent, procedure) {
            let resource = null;
            
            return function(props) {
                if (!resource) {
                    const promise = Promise.resolve(procedure());
                    resource = wrappedPromise(promise);
                }

                const data = resource.suspenseRead();
                return <WrappedComponent {...props} output={data} />;
            };
        }

        // UI 컴포넌트들
        function KernelUI(props) {
            return (
                <div className="success">
                    <div>KernelUI 완료 ## {props?.output}</div>
                    <div>{props.children}</div>
                </div>
            );
        }

        function BootUI(props) {
            return (
                <div className="success">
                    <div>BOOTUI 완료 ## {props?.output}</div>
                    <div>{props.children}</div>
                </div>
            );
        }

        function OSUI(props) {
            return (
                <div className="success">
                    <div>OSUI 완료 ## {props?.output}</div>
                    <div>{props.children}</div>
                </div>
            );
        }

        // HOC로 래핑된 컴포넌트들
        const KernelComp = withProcedure(KernelUI, () => {
            console.log("커널");
            return "커널 준비완료";
        });

        const BootComponent = withProcedure(
            BootUI,
            () =>
                new Promise((resolve) => {
                    setTimeout(() => {
                        console.log("부팅중");
                        resolve("System 준비완료");
                    }, 2000);
                })
        );

        const UIComponent = withProcedure(
            OSUI,
            () =>
                new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // 50% 확률로 에러 발생
                        if (Math.random() > 0.5) {
                            reject(new Error("OS 로딩 실패!"));
                        } else {
                            resolve("OS 준비완료");
                        }
                    }, 3000);
                })
        );

        // Error Boundary
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="error">
                            에러 발생: {this.state.error?.message || "알 수 없는 에러"}
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // ErrorBoundary with custom fallback
        function ErrorBoundaryWithFallback({ children, fallback }) {
            return (
                <ErrorBoundary>
                    {children}
                </ErrorBoundary>
            );
        }

        class CustomErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    if (typeof this.props.fallback === 'function') {
                        return this.props.fallback(this.state.error);
                    }
                    if (this.props.fallback) {
                        return this.props.fallback;
                    }
                    return (
                        <div className="error">
                            에러 발생: {this.state.error?.message || "알 수 없는 에러"}
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // App 컴포넌트
        function App() {
            const [key, setKey] = useState(0);

            return (
                <div>
                    <button onClick={() => setKey(k => k + 1)}>
                        다시 시작 (현재: {key})
                    </button>
                    <hr />
                    <CustomErrorBoundary 
                        key={key}
                        fallback={
                            <div style={{ 
                                padding: "20px", 
                                backgroundColor: "#fff3e0", 
                                border: "2px solid #ff9800",
                                borderRadius: "8px",
                                margin: "20px"
                            }}>
                                <h2>🔧 시스템 오류</h2>
                                <p>부팅 과정에서 문제가 발생했습니다. 다시 시작 버튼을 눌러주세요.</p>
                            </div>
                        }
                    >
                        <Suspense fallback={<div className="fallback">커널 부팅중...</div>}>
                            <KernelComp>
                                <CustomErrorBoundary fallback={<div className="error">⚠️ Boot 시스템 오류 발생!</div>}>
                                    <Suspense fallback={<div className="fallback">시스템 부팅중...</div>}>
                                        <BootComponent>
                                            <CustomErrorBoundary 
                                                fallback={(error) => (
                                                    <div style={{ 
                                                        padding: "10px", 
                                                        backgroundColor: "#ffebee", 
                                                        border: "1px solid #f44336",
                                                        borderRadius: "4px",
                                                        margin: "10px"
                                                    }}>
                                                        <strong>OS 로딩 실패:</strong> {error?.message || "알 수 없는 오류"}
                                                    </div>
                                                )}
                                            >
                                                <Suspense fallback={<div className="fallback">OS 준비중..</div>}>
                                                    <UIComponent>
                                                        <Suspense fallback={<div className="fallback">OS 준비중..1</div>}>
                                                            <UIComponent />
                                                        </Suspense>
                                                    </UIComponent>
                                                </Suspense>
                                            </CustomErrorBoundary>
                                        </BootComponent>
                                    </Suspense>
                                </CustomErrorBoundary>
                            </KernelComp>
                        </Suspense>
                    </CustomErrorBoundary>
                </div>
            );
        }

        // 렌더링
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
