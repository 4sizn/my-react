<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suspense Test</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .fallback {
            color: blue;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, Suspense, Component } = React;
        
        // wrappedPromise í•¨ìˆ˜
        function wrappedPromise(promise) {
            let status = "pending";
            let result = undefined;

            const suspender = promise
                .then((data) => {
                    status = "success";
                    result = data;
                })
                .catch((error) => {
                    status = "error";
                    result = error;
                });

            return {
                suspenseRead() {
                    if (status === "pending") {
                        throw suspender;
                    } else if (status === "error") {
                        throw result;
                    } else if (status === "success") {
                        return result;
                    }
                },
            };
        }

        // withProcedure HOC
        function withProcedure(WrappedComponent, procedure) {
            let resource = null;
            
            return function(props) {
                if (!resource) {
                    const promise = Promise.resolve(procedure());
                    resource = wrappedPromise(promise);
                }

                const data = resource.suspenseRead();
                return <WrappedComponent {...props} output={data} />;
            };
        }

        // UI ì»´í¬ë„ŒíŠ¸ë“¤
        function KernelUI(props) {
            return (
                <div className="success">
                    <div>KernelUI ì™„ë£Œ ## {props?.output}</div>
                    <div>{props.children}</div>
                </div>
            );
        }

        function BootUI(props) {
            return (
                <div className="success">
                    <div>BOOTUI ì™„ë£Œ ## {props?.output}</div>
                    <div>{props.children}</div>
                </div>
            );
        }

        function OSUI(props) {
            return (
                <div className="success">
                    <div>OSUI ì™„ë£Œ ## {props?.output}</div>
                    <div>{props.children}</div>
                </div>
            );
        }

        // HOCë¡œ ë˜í•‘ëœ ì»´í¬ë„ŒíŠ¸ë“¤
        const KernelComp = withProcedure(KernelUI, () => {
            console.log("ì»¤ë„");
            return "ì»¤ë„ ì¤€ë¹„ì™„ë£Œ";
        });

        const BootComponent = withProcedure(
            BootUI,
            () =>
                new Promise((resolve) => {
                    setTimeout(() => {
                        console.log("ë¶€íŒ…ì¤‘");
                        resolve("System ì¤€ë¹„ì™„ë£Œ");
                    }, 2000);
                })
        );

        const UIComponent = withProcedure(
            OSUI,
            () =>
                new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // 50% í™•ë¥ ë¡œ ì—ëŸ¬ ë°œìƒ
                        if (Math.random() > 0.5) {
                            reject(new Error("OS ë¡œë”© ì‹¤íŒ¨!"));
                        } else {
                            resolve("OS ì¤€ë¹„ì™„ë£Œ");
                        }
                    }, 3000);
                })
        );

        // Error Boundary
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="error">
                            ì—ëŸ¬ ë°œìƒ: {this.state.error?.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬"}
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // ErrorBoundary with custom fallback
        function ErrorBoundaryWithFallback({ children, fallback }) {
            return (
                <ErrorBoundary>
                    {children}
                </ErrorBoundary>
            );
        }

        class CustomErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    if (typeof this.props.fallback === 'function') {
                        return this.props.fallback(this.state.error);
                    }
                    if (this.props.fallback) {
                        return this.props.fallback;
                    }
                    return (
                        <div className="error">
                            ì—ëŸ¬ ë°œìƒ: {this.state.error?.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬"}
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // App ì»´í¬ë„ŒíŠ¸
        function App() {
            const [key, setKey] = useState(0);

            return (
                <div>
                    <button onClick={() => setKey(k => k + 1)}>
                        ë‹¤ì‹œ ì‹œì‘ (í˜„ì¬: {key})
                    </button>
                    <hr />
                    <CustomErrorBoundary 
                        key={key}
                        fallback={
                            <div style={{ 
                                padding: "20px", 
                                backgroundColor: "#fff3e0", 
                                border: "2px solid #ff9800",
                                borderRadius: "8px",
                                margin: "20px"
                            }}>
                                <h2>ğŸ”§ ì‹œìŠ¤í…œ ì˜¤ë¥˜</h2>
                                <p>ë¶€íŒ… ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                            </div>
                        }
                    >
                        <Suspense fallback={<div className="fallback">ì»¤ë„ ë¶€íŒ…ì¤‘...</div>}>
                            <KernelComp>
                                <CustomErrorBoundary fallback={<div className="error">âš ï¸ Boot ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ!</div>}>
                                    <Suspense fallback={<div className="fallback">ì‹œìŠ¤í…œ ë¶€íŒ…ì¤‘...</div>}>
                                        <BootComponent>
                                            <CustomErrorBoundary 
                                                fallback={(error) => (
                                                    <div style={{ 
                                                        padding: "10px", 
                                                        backgroundColor: "#ffebee", 
                                                        border: "1px solid #f44336",
                                                        borderRadius: "4px",
                                                        margin: "10px"
                                                    }}>
                                                        <strong>OS ë¡œë”© ì‹¤íŒ¨:</strong> {error?.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}
                                                    </div>
                                                )}
                                            >
                                                <Suspense fallback={<div className="fallback">OS ì¤€ë¹„ì¤‘..</div>}>
                                                    <UIComponent>
                                                        <Suspense fallback={<div className="fallback">OS ì¤€ë¹„ì¤‘..1</div>}>
                                                            <UIComponent />
                                                        </Suspense>
                                                    </UIComponent>
                                                </Suspense>
                                            </CustomErrorBoundary>
                                        </BootComponent>
                                    </Suspense>
                                </CustomErrorBoundary>
                            </KernelComp>
                        </Suspense>
                    </CustomErrorBoundary>
                </div>
            );
        }

        // ë Œë”ë§
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
