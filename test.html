<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suspense Test</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .fallback {
            color: blue;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, Suspense, Component } = React;
        
        // wrappedPromise 함수
        function wrappedPromise(promise) {
            let status = "pending";
            let result = undefined;

            const suspender = promise
                .then((data) => {
                    status = "success";
                    result = data;
                })
                .catch((error) => {
                    status = "error";
                    result = error;
                });

            return {
                suspenseRead() {
                    if (status === "pending") {
                        throw suspender;
                    } else if (status === "error") {
                        throw result;
                    } else if (status === "success") {
                        return result;
                    }
                },
            };
        }

        // withProcedure HOC
        function withProcedure(WrappedComponent, procedure) {
            let resource = null;
            
            return function(props) {
                if (!resource) {
                    const promise = Promise.resolve(procedure());
                    resource = wrappedPromise(promise);
                }

                const data = resource.suspenseRead();
                return <WrappedComponent {...props} output={data} />;
            };
        }

        // UI 컴포넌트들
        function KernelUI(props) {
            return (
                <div className="success">
                    <div>KernelUI 완료 ## {props?.output}</div>
                    <div>{props.children}</div>
                </div>
            );
        }

        function BootUI(props) {
            return (
                <div className="success">
                    <div>BOOTUI 완료 ## {props?.output}</div>
                    <div>{props.children}</div>
                </div>
            );
        }

        function OSUI(props) {
            return (
                <div className="success">
                    <div>OSUI 완료 ## {props?.output}</div>
                    <div>{props.children}</div>
                </div>
            );
        }

        // HOC로 래핑된 컴포넌트들
        const KernelComp = withProcedure(KernelUI, () => {
            console.log("커널");
            return "커널 준비완료";
        });

        const BootComponent = withProcedure(
            BootUI,
            () =>
                new Promise((resolve) => {
                    setTimeout(() => {
                        console.log("부팅중");
                        resolve("System 준비완료");
                    }, 2000);
                })
        );

        const UIComponent = withProcedure(
            OSUI,
            () =>
                new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // 50% 확률로 에러 발생
                        if (Math.random() > 0.5) {
                            reject(new Error("OS 로딩 실패!"));
                        } else {
                            resolve("OS 준비완료");
                        }
                    }, 3000);
                })
        );

        // Error Boundary
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="error">
                            에러 발생: {this.state.error?.message || "알 수 없는 에러"}
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // App 컴포넌트
        function App() {
            const [key, setKey] = useState(0);

            return (
                <div>
                    <button onClick={() => setKey(k => k + 1)}>
                        다시 시작 (현재: {key})
                    </button>
                    <hr />
                    <ErrorBoundary key={key}>
                        <Suspense fallback={<div className="fallback">커널 부팅중...</div>}>
                            <KernelComp>
                                <Suspense fallback={<div className="fallback">시스템 부팅중...</div>}>
                                    <BootComponent>
                                        <Suspense fallback={<div className="fallback">OS 준비중..</div>}>
                                            <UIComponent>
                                                <Suspense fallback={<div className="fallback">OS 준비중..1</div>}>
                                                    <UIComponent />
                                                </Suspense>
                                            </UIComponent>
                                        </Suspense>
                                    </BootComponent>
                                </Suspense>
                            </KernelComp>
                        </Suspense>
                    </ErrorBoundary>
                </div>
            );
        }

        // 렌더링
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
